<?php

function wallynewssitemap_menu() {
  $items = array();

  $items['admin/wally/wallysitemap/newssitemap'] = array(
    'title'            => t('News Sitemap'),
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('wallynewssitemap_admin_settings_page_form'),
    'access arguments' => array('administer sitemaps'),
    'file'             => 'includes/wallynewssitemap.admin.inc',
    'weight'           => 1,
    'type'             => MENU_LOCAL_TASK,
  );

  return $items;
}

function wallynewssitemap_cron() {
  $return = '<b>'.t('Run').' '.date('Y-m-d H:i:s').' :</b></br>';
  
  if ($settings = wally_variable_get('wallynewssitemap_sitemaps_settings', FALSE)) {
    module_load_include('inc', 'wallytoolbox', 'includes/wallytoolbox.helpers');
    wallytoolbox_set_microtime_step('', FALSE, 'wallynewssitemap_cron');
    
    $site_infos = wallysitemap_get_site_infos();
    module_load_include('inc', 'wallynewssitemap', 'includes/wallynewssitemap.generate_xml');
    _wallynewssitemap_generate_sitemap_xml($site_infos, $settings);
    
    $delta_t_global = wallytoolbox_set_microtime_step('', FALSE, 'wallynewssitemap_cron');
    $micro = sprintf('%06d', ($delta_t_global - floor($delta_t_global)) * 1000000);
    $d = new DateTime(date('Y-m-d H:i:s.'.$micro, $delta_t_global));
    $formatted = $d->format('i:s.u');
    $return .= '<b>'.t('Total Runtime : !delta_t', array('!delta_t' => $formatted)).'</b></br>';
  } else {
    $return .= t('The module has not been configured yet, the sitemap will not be generated untill the configuration is set.');
  }
  
  print $return;
}

/**
 * Will be called by wallynewssitemap to build default settings.
 */
function wallynewssitemap_default_settings() {
  return array(
    'wallynewssitemap_path' => 'sites/default/files/sitemaps',
    'wallynewssitemap_consolidate_sitemap' => 0,
    'wallynewssitemap_add_images' => 0,
    'wallynewssitemap_add_videos' => 0,
    'wallynewssitemap_blacklist' => array(),
    'wallynewssitemap_publication_name' => variable_get('site_name', ''),
    'wallynewssitemap_content_types' => array('wally_articlepackage', 'wally_gallerypackage', 'wally_pollpackage', 'page'),
    'wallynewssitemap_tags_fields' => array(),
    'wallynewssitemap_image_preset' => '',
    'wallynewssitemap_image_license' => '',
    'wallynewssitemap_video_preset' => '',
    'wallynewssitemap_default_img' => drupal_get_path('module', 'wallynewssitemap').'/images/default_pic.jpg',
    'wallynewssitemap_allow_embed' => 'no',
  );
}
