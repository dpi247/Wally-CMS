<?php

//@todo: DDU initialiser correctement les valeurs de settings des fields lors de l'install du module 
//@todo: DDU le poids system doit être changé lors du hook_install => done

include_once 'includes/Prenode.inc';
/**
 * @file
 * wallyedit module
 *
 * This module provide coherent edition interface for package type
 *
 */
 
/*
 * Implementation du hook menu
 */ 
function wallyedit_menu(){
  return array(
      'admin/content/wallyedit'=>array(
      'page callback'=>'wallyedit_page_admin',
      'access arguments' => 'administer nodes',
  	  'file'=>'includes/page_admin.inc',
  	  //'file path'=>'includes/',
  	  'title'=> 'WallyEdit Admin',
  	  'Description'=> 'Manage Node Edition',
    ),
    'node/%prenode/edit2/%ctools_js'=>array(
      'page callback'=>'wallyedit_page_node_edition',
      'page arguments'=>array(1,3),
      'access callback' => 'node_access',
      'access arguments' => array('update', 1),
  	  'file'=>'includes/page_node_edition.inc',
  	  //'file path'=>'includes/',
    ),
    'node/add2/%/%ctools_js'=>array(
      'page callback'=>'wallyedit_page_add',
      'page arguments'=>array(2),
      'access callback' => 'node_access',
      'access arguments' => array('create', 2),
  	  'file'=>'includes/page_add.inc',
  	  //'file path'=>'includes/',
    ),
    'node/%prenode/wydit_edit/%ctools_js'=>array(
      'page callback'=>'wallyedit_callback_edit',
      'page arguments'=>array(1,3),
      'access callback' => 'node_access',
      'access arguments' => array('update', 1),
  	  'file'=>'includes/callback_edit.inc',
  	  //'file path'=>'includes/',
    ),
    'node/%prenode/wydit_selectbox/%ctools_js'=>array(
      'page callback'=>'wallyedit_callback_selectbox',
      'page arguments'=>array(1,3),
      'access callback' => 'node_access',
      'access arguments' => array('update', 1),
  	  'file'=>'includes/callback_selectbox.inc',
  	  //'file path'=>'includes/',
    ),
    'node/%prenode/wydit_typeselector/%ctools_js'=>array(
      'page callback'=>'wallyedit_callback_typeselector',
      'page arguments'=>array(1,3),
      'access callback' => 'node_access',
      'access arguments' => array('update', 1),
  	  'file'=>'includes/callback_typeselector.inc',
  	  //'file path'=>'includes/',
    ),
    'node/%prenode/wydit_add_new/%ctools_js'=>array(
      'page callback'=>'wallyedit_callback_add_new',
      'page arguments'=>array(1,3),
      'access callback' => 'node_access',
      'access arguments' => array('update', 1),
  	  'file'=>'includes/callback_add_new.inc',
  	  //'file path'=>'includes/',
    ),
    'wallyedit/test'=>array(
      'type'=> MENU_LOCAL_TASK,
      'page callback'=>'wallyedit_test',
      'page arguments'=>array(1),
      'access callback' => 'node_access',
      'access arguments' => array('update', 1),
  	  'file'=>'includes/test.inc',
  	  //'file path'=>'includes/',
    ),
  );
}
function wallyedit_form_alter(&$form, &$form_state, $form_id){
  if($form_id=='content_display_overview_form'){
    
    module_load_include("inc",'content','includes/content.node_form');
    
    $type_name=$form['#type_name'];
   
    $type=content_types($type_name);
    
    $fields = $type['fields'];
    
    $groups = array();
    if (module_exists('fieldgroup')) {
      $groups = fieldgroup_groups($type['type']);
    }
       foreach($form["#fields"] as $field){
       $form[$field]["wallyedit"]=array(
         '#type'=>'select',
         '#options'=>array(0=>t("Exclude"),1=>t("Normal")),
       );
       if($fields[$field]['type']=='nodereference'){
       $form[$field]["wallyedit"]["#options"]=array_merge($form[$field]["wallyedit"]["#options"],array(2=>t('inline'),3=>t('Select box')));
       }
       $form[$field]["wallyedit"]["#default_value"]=$fields[$field]['display_settings']['wallyedit'];
     }
     foreach($form["#groups"] as $field){}
  }
  
  
  
  if($form_id=='wally_photoobject_node_form'){
    $form["#after_build"][]='wydit_test_form';
    //$form['#validate']=array();
    
  }
  
}
function wydit_test_form(&$form, &$form_state){
  
 /* unset($form["#validate"]);
  $form['#validate']=array();
  $form['group_photo']['field_thumbnail'][0]["#post"]=array();
  $form['group_photo']['field_thumbnail'][0]["#processed"]=FALSE;
  unset(  $form['group_photo']['field_thumbnail'][0]["#processed"]);
*/
  return $form;

}
function wallyedit_theme(){
  $path = drupal_get_path('module', 'wallyedit');
  $base = array(
    'file' => 'theme.inc',
    'path' => "$path/theme",
  );
  
  return array(
    'wallyedit_admin'=>$base+array(
     // 'template' => 'my-template-day-node',
      'arguments' => array('rows'=>array()),
      ),
    'wallyedit_page_createmode'=>$base+array(
     // 'template' => 'my-template-day-node',
      'arguments' => array('form'=>array(),'prenode' => NULL),
      ),
    'wallyedit_page_editmode'=>$base+array(
     // 'template' => 'my-template-day-node',
      'arguments' => array('form'=>array(),'prenode' => NULL),
      ),
    'content_display_overview_form'=>array(
      'template' => 'wallyedit-admin-display-overview-form',
      'arguments' => array('form'=>array()),
      'path' => drupal_get_path('module', 'wallyedit') . '/theme',
      'original hook' => 'content_display_overview_form',
      ),
      'wydit_selector_theme'=>$base+array(
     // 'template' => 'my-template-day-node',
      'arguments' => array('form'=>array()),
      ),
  );
}

function wallyedit_form_page_createmode_form(&$form_state){

  
  $form=array('#tree'=>true);
  
  $form['#action']='/node/add2/'.arg(2).'/ajax/'.$form_state['cache name'];
  //$form['#no_cache']=true;
 
  $type_name=$form_state['type'];
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  $a=array("#tree"=>true);      
  $a=drupal_retrieve_form($type_name.'_node_form',$a,$form_state[$type_name]['#node']);
  $a['#tree']=true;
  drupal_prepare_form($type_name.'_node_form',$a,$form_state);
  
  unset($a["#type"]);
  unset($a["form_id"]);
  unset($a["#parents"]);
  $form[$type_name]=array("#type"=>'fieldset');
  foreach($a as $element_name=>$value){
      $form[$type_name][$element_name]=$value;
  }
  wydit_prepare_primary_package_form($form[$type_name],$form_state,$type['type'],$fields,array(0=>$type['type']));
  
  wydit_remove_form_infos($form[$type_name]);
  
  $form['#tree']=true;
  
   
 
  $form["save_global"]=array(
    '#type'=>'submit',
    '#name'=>'save_global',
    "#value"=> 'Save',
  	'#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
  
  
  ); 
    $form['#tree']=true;
    
    $form["reset_global"]=array(
    '#type'=>'submit',
    '#name'=>'reset_global',
    "#value"=> 'Reset',
   // 	'#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
    
  
  );
  
    $form["publish_global"]=array(
    '#type'=>'submit',
    '#name'=>'publish_global',
    "#value"=> 'Publish',
    
  
  );
  return $form;
}
function wallyedit_form_page_createmode_form_submit($form,&$form_state){
  
  ctools_include('form');
  ctools_include('modal');
  ctools_include('ajax');
  ctools_add_js('ajax-responder');
  ctools_include('object-cache');
  ctools_modal_add_js();
 
 $commands=array();
 
  if($form_state["clicked_button"]['#name']=='reset_global'){
    drupal_set_message('reset');
    ctools_object_cache_clear('prenode', $form_state['cache name']);
    

    drupal_goto("node/".$form_state[$form_state['type']]['#node']->nid);
    
  }
  
  
  
  
  //*********
  //Prepare form_state for input element
  //*********
  
  $b = node_submit($form_state['values']);
  
  $a=array();
  $a[$form_state['type']]['#node']=(object)((array)node_submit($form_state['values'][$form_state['type']])+(array)$form_state[$form_state['type']]['#node']);
  $a[$form_state['type']]['type']=$form_state['type'];
  $a['type']=$form_state['type'];
  $a['cache name']=$form_state['cache name'];
  
  
  $type_name=$form_state['type'];
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  
  
  foreach($fields as $field){
         
    if($field['display_settings']["wallyedit"]>1){
      $a[$form_state['type']][$field['field_name']]=array();
      if(isset($form_state[$form_state['type']][$field['field_name']])){
      
        foreach($form_state[$form_state['type']][$field['field_name']] as $key=>$value){
          $a[$form_state['type']][$field['field_name']][$key]['#node']=(object)((array)node_submit($form_state['values'][$form_state['type']][$field['field_name']][$key])+(array)$form_state[$form_state['type']][$field['field_name']][$key]['#node']);
          $subtype=$a[$form_state['type']][$field['field_name']][$key]['#node']->type;
          $a[$form_state['type']][$field['field_name']][$key]['type']=$subtype;
        }
      }
    }
  
  }
  
  //@todo: DDU use same technique as for ubercart order (for unique "nid");
  ctools_object_cache_set('prenode', $a['cache name'], $a);
  
  if($form_state["clicked_button"]['#name']=='publish_global'){
    
    wydit_publish_prenode($a);
    
    drupal_set_message('Node has been published');
    ctools_object_cache_clear('prenode', $form_state['cache name']);
    drupal_set_message('PreNode has been cleared');
    drupal_goto("node/".$form_state[$form_state['type']]['#node']->nid);
    
  }
  
  
  //*********
  //DISPATCH
  //*********
 
  
  $action =split('__',$form_state['clicked_button']['#name']);
  $action=$action[0];
  
  switch($action){
    
    case 'edit':
      $new_form_state=array();
      $new_form_state['parents']=$form_state['clicked_button']["#parents"];
      $new_form_state['cache name']=$form_state["cache name"];
      
      $new_form_state['action']='/node/'.$form_state['cache name'].'/wydit_edit/ajax';
      $new_form_state[$form_state['type']]=$form_state[$form_state['type']];
      $edit_form = ctools_build_form('wallyedit_form_editmode_edit_form', $new_form_state);
      $commands[] = ctools_ajax_command_html('#wallyedit_container',$edit_form);  
      //$commands[] = ctools_ajax_command_html('#wallyedit_container','ee');  
      
    break;
    case 'add_new':
      //@todo: remove hard coding of parents
      $field_infos=$fields[$form_state['clicked_button']["#parents"][1]];
      if(count($field_infos['referenceable_types'])==1){
        
      }
      else{
        
        //$form_state_type_selector=wydit_clean_form_state($form_state);
        $form_state_type_selector['fields_infos']=$field_infos;
        $new_form_state['action']='/node/'.$form_state['cache name'].'/wydit_typeselector/ajax';
        $form_state_type_selector['cache name']=$form_state['cache name'];
        
        $form_state_type_selector['parents']=$form_state['clicked_button']["#parents"];
        $form_type_selector = ctools_build_form('wallyedit_form_nodetypeselector_form', $form_state_type_selector);
        $commands[] = ctools_ajax_command_html('#wallyedit_container',$form_type_selector);  
      }
    break; 
    case 'add_existing':
      
          
      $view = views_get_view('prenode_selectbox_vbo');
      $view->set_display('default');
      
      // set the view arguments here, if needed : SET the cache name and the target
      $view->set_arguments( array( $form_state['cache name'], implode('/',$form_state['clicked_button']["#parents"])) );
    
      // Override the view path, otherwise the path will be 'ACTION_URL' and AJAX will not be take into account
      $view->override_path = 'views/ajax';
      $output = $view->preview();
    
      $commands[] = ctools_ajax_command_html('#wallyedit_container',$output);  
    break;
    case 'save_global':
    break;
    case 'remove':
      $form_state=wydit_remove_element($form_state,$form_state['clicked_button']['#parents']);

      wydit_clean_and_save_form_state($form_state);
      
      $prenode=new Prenode($form_state[$form_state['type']]['#node']->nid);
      $new_form_state=$prenode->getFormState();
      unset($_POST);
      $new_form_state['want form']=TRUE  ;
      
      
      $new_form = ctools_build_form('wallyedit_form_page_editmode_form', wydit_clean_form_state($new_form_state));
      $commands[] = ctools_ajax_command_html('#wallyedit_container',$new_form); 
      
      //ctools_ajax_render($commands); 
      
    break;
  }
 
   $commands[] = ctools_ajax_command_html('#wallyedit_messages', theme_status_messages());
  //$commands[] = ctools_ajax_command_html('#wallyedit_container', theme_status_messages());
  ctools_ajax_render($commands); 
 
  
}

function wallyedit_form_page_editmode_form(&$form_state){

  $form=wydit_subform_global_page_form($form_state);
  $form['#action']='/node/'.$form_state['cache name'].'/edit2/1';
  return $form;
}

function wydit_subform_global_page_form(&$form_state){
 //$form['#no_cache']=true;
  $form=array('#tree'=>true);
  
  $type_name=$form_state['type'];
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  $a=array("#tree"=>true);      
  $a=drupal_retrieve_form($type_name.'_node_form',$a,$form_state[$type_name]['#node']);
  $a['#tree']=true;
  drupal_prepare_form($type_name.'_node_form',$a,$form_state);
  
  unset($a["#type"]);
  unset($a["form_id"]);
  unset($a["#parents"]);
  $form[$type_name]=array("#type"=>'fieldset');
  foreach($a as $element_name=>$value){
      $form[$type_name][$element_name]=$value;
  }
  wydit_prepare_primary_package_form($form[$type_name],$form_state,$type['type'],$fields,array(0=>$type['type']));
  
  wydit_remove_form_infos($form[$type_name]);
  
  $form['#tree']=true;
  
  
  $form["save_global"]=array(
    '#type'=>'submit',
    '#name'=>'save_global',
    "#value"=> 'Save',
  	'#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
  
  
  ); 
    $form['#tree']=true;
    
    $form["reset_global"]=array(
    '#type'=>'submit',
    '#name'=>'reset_global',
    "#value"=> 'Reset',
   // 	'#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
    
  
  );
  
    $form["publish_global"]=array(
    '#type'=>'submit',
    '#name'=>'publish_global',
    "#value"=> 'Publish',
    
  
  ); 
  
  return $form;
}



function wydit_prepare_primary_package_form(& $form,&$form_state,$type,$fields,$parents){
  foreach(element_children($form) as $element){
    $parents_new=$parents;
    $parents_new[]=$element;
    if($form[$element]['#type']=='value'){
    //$form[$element]['#parents']=$parents;
      continue;
    }
    if($form[$element]['#type']=='fieldset'){
      wydit_prepare_primary_package_form(&$form[$element],$form_state,$type,$fields,$parents);
      wydit_changetypefromfieldset($form[$element],$fields);
    }
    if(isset($fields[$element]) and $fields[$element]['display_settings']["wallyedit"]==0 ){
      //@todo: DDU what happen if the element is required ?
      //if($form[$element]['#required']==false){
      unset($form[$element]);
      //}
      //else{dsm($form[$element]);}
    }
    if(isset($fields[$element]) and $fields[$element]['display_settings']["wallyedit"]==1 ){
      
      $form[$element]['#parents']=$parents_new;
      //@todo: DDU what happen if the element is required ?
      //if($form[$element]['#required']==false){
            //}
      //else{dsm($form[$element]);}
    }
    
  if(isset($fields[$element]) and $fields[$element]['display_settings']["wallyedit"]==2 ){
    $parents_new[]=0;
      wydit_prepare_inline_form_element($form[$element],$form_state[$type][$element][0],$element,$fields,$parents_new  );  
      //$form[$element]['#parents']=array($element);
    }
  if(isset($fields[$element]) and $fields[$element]['display_settings']["wallyedit"]==3 ){
     wydit_prepare_selectbox_form_element($form[$element],$form_state[$type][$element],$element,$fields,$parents_new  );  
      //$form[$element]['#parents']=array($element);
    }
  }
     
  unset($form['menu']);
  unset($form['buttons']);
  unset($form['author']);
  unset($form['revision_information']);
  unset($form['options']);
  unset($form['comment_settings']);
  unset($form['#theme']);
  
  
  /*
    unset($form['#id']);
    unset($form['#attributes']);
    unset($form['#parameters']);
    unset($form['#node']);
    unset($form['#after_build']);
    
    unset($form['#pre_render']);
    unset($form['#attributes']);
    unset($form['#validate']);
    
  */
  unset($form['#submit']);
  unset($form['#disabled']);
  
  

 
}




function wallyedit_form_page_editmode_form_validate($form,&$form_state){

}


function wallyedit_form_page_editmode_form_submit($form,&$form_state){
  ctools_include('form');
  ctools_include('modal');
  ctools_include('ajax');
  ctools_add_js('ajax-responder');
  ctools_modal_add_js();
  ctools_include('object-cache');
  $commands=array();
 
  if($form_state["clicked_button"]['#name']=='reset_global'){
    drupal_set_message('reset');
    ctools_object_cache_clear('prenode', $form_state['cache name']);
    drupal_set_message('PreNode has been cleared');
    
    drupal_goto("node/".$form_state[$form_state['type']]['#node']->nid);
  }
  
  //This is the important line !!!
  wydit_subform_global_page_submit($form_state);

  if($form_state["clicked_button"]['#name']=='publish_global'){
    wydit_publish_prenode($form_state);
    drupal_set_message('Node has been published');
    ctools_object_cache_clear('prenode', $form_state['cache name']);
    drupal_set_message('PreNode has been cleared');
    drupal_goto("node/".$form_state[$form_state['type']]['#node']->nid);
  }
  
  
  //*********
  //DISPATCH
  //*********
 
  
  $action =split('__',$form_state['clicked_button']['#name']);
  $action=$action[0];
  
  switch($action){
    
    case 'edit':
      $new_form_state=array();
      $new_form_state['parents']=$form_state['clicked_button']["#parents"];
      $new_form_state['action']='/node/'.$form_state['cache name'].'/wydit_edit/ajax';
      $new_form_state[$form_state['type']]=$form_state[$form_state['type']];
      $new_form_state['cache name']=$form_state['cache name'];
      
      $new_form_state['type']=$form_state['type'];
      $edit_form = ctools_build_form('wallyedit_form_editmode_edit_form', $new_form_state);
      $commands[] = ctools_ajax_command_html('#wallyedit_container',$edit_form);  
      //$commands[] = ctools_ajax_command_html('#wallyedit_container','ee');  
      
    break;
    case 'add_new':
      
      $type_name=$form_state['type'];
      $type=wydit_get_infos_type($type_name);
      $fields = $type['fields'];
      //@todo: remove hard coding of parents
      $field_infos=$fields[$form_state['clicked_button']["#parents"][1]];
      if(count($field_infos['referenceable_types'])==1){
      
      }
      else{
        
        //$form_state_type_selector=wydit_clean_form_state($form_state);
        //fields_infos is set in wydit_subform_global_page_submit()
        $form_state_type_selector['fields_infos']=$field_infos;
        $form_state_type_selector['action']='/node/'.$form_state['cache name'].'/wydit_typeselector/ajax';
        
        //$form_state_type_selector['input']=array();
        $form_state_type_selector['cache name']=$form_state['cache name'];
        $form_state_type_selector['parents']=$form_state['clicked_button']["#parents"];
        $form_state_type_selector[$form_state['type']]=$form_state[$form_state['type']];
        $form_state_type_selector['type']=$form_state['type'];
      
        $form_type_selector = ctools_build_form('wallyedit_form_nodetypeselector_form', $form_state_type_selector);
        $commands[] = ctools_ajax_command_html('#wallyedit_container',$form_type_selector);  
      }
    break;
    case 'add_existing':
      $type_name=$form_state['type'];
      $type=wydit_get_infos_type($type_name);
      $fields = $type['fields'];
      //@todo: remove hard coding of parents
      $field_infos=$fields[$form_state['clicked_button']["#parents"][1]];
      
      $referencables=$field_infos['referenceable_types'];
      foreach($referencables as $value){
        if($value){
          $allowed_types[$value]=$value;
        }
      }
          
      $handler_type_filter=array(  
        'type' => array(
          'operator' => 'in',
          'value' =>$allowed_types,
          'group' => '0',
          'exposed' => FALSE,
          'expose' => array(
            'operator' => FALSE,
            'label' => '',
          ),
          'id' => 'type',
          'table' => 'node',
          'field' => 'type',
          'relationship' => 'none',
        ),
        );
      
      $view = views_get_view('prenode_selectbox_vbo');
      $view->set_display('default');
      
      $view->display[$view->current_display]->handler->options['filters']=array_merge($view->display[$view->current_display]->handler->options['filters'],$handler_type_filter);
      $view->display[$view->current_display]->handler->display_options['filters']=array_merge($view->display[$view->current_display]->handler->display_options['filters'],$handler_type_filter);
      
      // set the view arguments here, if needed : SET the cache name and the target
      $view->set_arguments( array( $form_state['cache name'], implode('/',$form_state['clicked_button']["#parents"])) );
    
      // Override the view path, otherwise the path will be 'ACTION_URL' and AJAX will not be take into account
      $view->override_path = 'views/ajax';
      $output = $view->preview();
    
      $commands[] = ctools_ajax_command_html('#wallyedit_container',$output);  
    break;
    case 'save_global':
    break;
    case 'remove':
      $form_state=wydit_remove_element($form_state,$form_state['clicked_button']['#parents']);

      wydit_clean_and_save_form_state($form_state);
      
      $prenode=new Prenode($form_state['cache name']);
      $new_form_state=$prenode->getFormState();
      unset($_POST);
      $new_form_state['want form']=TRUE  ;
      
      $new_form = ctools_build_form('wallyedit_form_page_editmode_form', wydit_clean_form_state($new_form_state));
      $commands[] = ctools_ajax_command_html('#wallyedit_container',$new_form); 
      
      //ctools_ajax_render($commands); 
      
    break;
  }
 
   
  $commands[] = ctools_ajax_command_html('#wallyedit_messages', theme_status_messages());
  ctools_ajax_render($commands); 
}

function wallyedit_editmode_selectbox_form($form_state){
  
  $form=array();
  /*
    $_POST['form_build_id']='rrrfffgggttt'; 
    $_POST['form_id']='rfeedd';
  */
  views_add_js('ajax_view');
  
  $views= views_embed_view('prenode_selectbox_vbo', 'default', 6,64);
  
  $args=array(6,64);
  $view = views_get_view('prenode_selectbox_vbo');

  
  
    $conf=array(
    "override_pager_settings"=>0,
  'use_pager'=>0,
  'nodes_per_page'=>20,
  "pager_id"=>'',
  );
  $block=views_content_views_content_type_render('prenode_selectbox_vbo',$conf,array(),array());

  $form['vbo']=array(
    '#type'=>'markup',
    '#value'=>$block->content,
  );
    $form['sub']=array(
    '#type'=>'submit',
    '#value'=>'luncj',
  );
  $form['#action']=$form_state['action'];
  return $form;

}

function wallyedit_editmode_selectbox_form_submit($form,&$form_state){
watchdog('wallyedit', 'rrrrrrrrrrrrrrrrrrrrrrrrrrr');
  ctools_include('form');
  ctools_include('modal');
  ctools_include('ajax');
  ctools_add_js('ajax-responder');
  ctools_modal_add_js();
 //$commands[] = ctools_ajax_command_html('#wallyedit_container',$form);  
  $commands[] = ctools_ajax_command_html('#wallyedit_messages', theme_status_messages());
  
  ctools_ajax_render($commands); 

}
// important: add fields infos to form_state
function wydit_subform_global_page_submit(&$form_state){

  //*********
  //Prepare form_state for input element
  //*********
  
  $b = node_submit($form_state['values']);
  
  $a=array();
  $a[$form_state['type']]['#node']=(object)((array)node_submit($form_state['values'][$form_state['type']])+(array)$form_state[$form_state['type']]['#node']);
  $a['type']=$form_state['type'];
  $a['cache name']=$form_state['cache name'];
  
  
  $type_name=$form_state['type'];
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  foreach($fields as $field){
         
    if($field['display_settings']["wallyedit"]>1){
      if(isset($form_state[$form_state['type']][$field['field_name']])){
      
        foreach($form_state[$form_state['type']][$field['field_name']] as $key=>$value){
          //avoid the weight_.$key element
          if(is_numeric($key)){
            //determine index, if no wieght -inline element- use $key value
            if(isset($form_state['values'][$form_state['type']][$field['field_name']]["weight_".$key])){
              $index=$form_state['values'][$form_state['type']][$field['field_name']]["weight_".$key];
            }
            else{
              $index=$key;
            }

            $a[$form_state['type']][$field['field_name']][$index]['#node']=(object)((array)node_submit($form_state['values'][$form_state['type']][$field['field_name']][$key])+(array)$form_state[$form_state['type']][$field['field_name']][$key]['#node']);
            $subtype=$a[$form_state['type']][$field['field_name']][$index]['#node']->type;
            
            $a[$form_state['type']][$field['field_name']][$index]['type']=$subtype;
            
          }
          
          
          
         //ReOrder by index
         ksort( $a[$form_state['type']][$field['field_name']]);
         $a[$form_state['type']][$field['field_name']]=array_values($a[$form_state['type']][$field['field_name']]);
     
        }
        
      }
    //dsm($a);
    }
  
  }

  
  
  ctools_object_cache_set('prenode', $a['cache name'], $a);
  
}

function wallyedit_form_editmode_add_form(&$form_state){
  
  $form=wydit_subform_global_add_form(&$form_state);
  $form['#action']='/node/'.$form_state['cache name'].'/wydit_add_new/ajax';
  
  return $form;
}
function wydit_subform_global_add_form(&$form_state){
  $node->type=$form_state['type'];
  
  $type_name=$node->type;
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  
  
  //@todo: target should be parents ?
  $target=array_merge($form_state['parents'],array("#node"));
  $form['target']=array('#type'=>'value','#value'=>$target);
  $form['parents']=array('#type'=>'value','#value'=>$form_state['parents']);
  $form['type']=array('#type'=>'value','#value'=>$node->type);
  
  $a=array("#tree"=>true);      
  $a=drupal_retrieve_form($type_name.'_node_form',$a,$node);
  $a['#tree']=true;
  
  drupal_prepare_form($type_name.'_node_form',$a,$form_state);

  unset($a["#type"]);
  unset($a["form_id"]);
  unset($a["#parents"]);
  $form[$type_name]=array("#type"=>'fieldset');

  foreach($a as $element_name=>$value){
    $form[$type_name][$element_name]=$value;
  }
  
  wydit_prepare_primary_package_form($form[$type_name],$form_state,$type['type'],$fields,array(0=>$type['type']));
  
  wydit_remove_form_infos($form[$type_name]);
    
  $form['#tree']=true;
  
  $form["save_global"]=array(
    '#type'=>'submit',
    '#name'=>'save_global',
    "#value"=> 'Save AJAX',
  	'#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
  ); 
  $form['#tree']=true;
  
  return $form;
}
function wallyedit_form_editmode_add_form_submit($form,&$form_state){
  
  wydit_subform_global_add_form_submit($form,$form_state);
  
  $form = ctools_build_form('wallyedit_form_page_editmode_form', $form_state);
  $commands[] = ctools_ajax_command_html('#wallyedit_container',$form);  
  $commands[] = ctools_ajax_command_html('#wallyedit_messages', theme_status_messages());
  
  ctools_ajax_render($commands); 
}
function wydit_subform_global_add_form_submit($form,&$form_state){
  ctools_include('form');
  ctools_include('modal');
  ctools_include('ajax');
  ctools_add_js('ajax-responder');
  ctools_modal_add_js();
  ctools_include('object-cache');

  
  $node = node_submit($form_state['values'][$form_state['values']['type']]);
  // unset($node['form_token']);
  
  
  $b=$node;
  
  //$b=(object) $node;
  $element['#node']=$b;
  $element['type']=$b->type;
  array_pop($form_state['values']["parents"]);
  wydit_add_to_form_state($form_state,$element,$form_state['values']["parents"],TRUE);
  wydit_clean_and_save_form_state($form_state);
  
}

function wallyedit_form_editmode_edit_form(&$form_state){
  $form=wydit_subform_global_edit_form(&$form_state);
  $form['#action']='/node/'.$form_state['cache name'].'/wydit_edit/ajax';
  return $form;
  
}
function wydit_subform_global_edit_form(&$form_state){
  
  $node=wydit_get_current_node_from_parents($form_state);
  
  $type_name=$node->type;
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  $form['#tree']=TRUE;
  
  //@todo: target should be parents ?
  $target=array_merge($form_state['parents'],array("#node"));
  $form['target']=array('#type'=>'value','#value'=>$target);
  $form['parents']=array('#type'=>'value','#value'=>$form_state['parents']);
  $form['type']=array('#type'=>'value','#value'=>$node->type);
  
  $a=array("#tree"=>true);      
  $a=drupal_retrieve_form($type_name.'_node_form',$a,$node);
  $a['#tree']=true;
  
  drupal_prepare_form($type_name.'_node_form',$a,$form_state);

  unset($a["#type"]);
  unset($a["form_id"]);
  unset($a["#parents"]);
  $form[$type_name]=array("#type"=>'fieldset');

  foreach($a as $element_name=>$value){
    $form[$type_name][$element_name]=$value;
  }
  
  wydit_prepare_primary_package_form($form[$type_name],$form_state,$type['type'],$fields,array(0=>$type['type']));
  
  wydit_remove_form_infos($form[$type_name]);
    
  $form['#tree']=true;
  
  $form["save_global"]=array(
    '#type'=>'submit',
    '#name'=>'save_global',
    "#value"=> 'Save AJAX',
  	'#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
  ); 
  $form['#tree']=true;
  unset($form["#validate"]);
  return $form;
}

function wallyedit_form_editmode_edit_form_submit(&$form,&$form_state){
  wydit_subform_global_edit_form_submit($form,$form_state);
  $form = ctools_build_form('wallyedit_form_page_editmode_form', $form_state);
  $commands[] = ctools_ajax_command_html('#wallyedit_container',$form);  
  $commands[] = ctools_ajax_command_html('#wallyedit_messages', theme_status_messages());
  
  ctools_ajax_render($commands); 
  
}
function wydit_subform_global_edit_form_submit(&$form,&$form_state){
  ctools_include('form');
  ctools_include('modal');
  ctools_include('ajax');
  ctools_add_js('ajax-responder');
  ctools_modal_add_js();
  ctools_include('object-cache');
  
  $node=& wydit_get_current_node_from_parents($form_state,$form_state['values']['parents']);
  
  
  $b = $form_state['values'][$form_state['values']['type']];
  
  
  $a=array();
  $node=(object)((array)$b+(array) $node);
  
  wydit_add_to_form_state($form_state,$node,$form_state['values']['target']);
  wydit_clean_and_save_form_state($form_state);
  
  

}


function wallyedit_form_nodetypeselector_form(&$form_state){
  
  ctools_include('form');
  ctools_include('modal');
  ctools_include('ajax');
  ctools_add_js('ajax-responder');
  ctools_modal_add_js();
  ctools_include('object-cache');
  
  $type_name=$form_state['type'];
  
  $form=array('#tree'=>true);
  $form['#action']='/node/'.$form_state['cache name'].'/wydit_typeselector/ajax';
  $field_infos=$form_state['fields_infos'];
  $parents=$form_state['parents'];
  $form['parents33']=array('#type'=>'value','#value'=>$form_state['parents']);
  
  $content_types=_content_type_info();
 
  foreach($field_infos['referenceable_types'] as $type_name=>$value){
    if($value)
     $options[$type_name]=$content_types["content types"][$type_name]['name'];
  }
   
  $form['parents']=array(
     "#type"=>'hidden',
     "#value"=>serialize($parents),
  );
   
  
  $form['cache name']=array(
     "#type"=>'hidden',
     "#value"=>$form_state['cache name'],
  );
   
  $form['type'] = array(
  '#type' => 'radios',
  '#title' => t('Select the type of node to add'),
  '#options' => $options,
  "#required"=>true,
  );
  
  
  $form['back'] = array(
  '#type' => 'submit',
  "#name"=>'back',
  '#value'=>"back",
  '#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
  
  );
  $form['next'] = array(
  '#type' => 'submit',
  "#name"=>'next',
  '#value'=>"next",
  '#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
  
  );
  return $form;
}
function wallyedit_form_nodetypeselector_form_submit($form, &$form_state){
  ctools_include('form');
  ctools_include('modal');
  ctools_include('ajax');
  ctools_add_js('ajax-responder');
  ctools_modal_add_js();
  ctools_include('object-cache');
  
  
  
  $commands=array();
  $values=$form_state['values'];
  $type=$values['type'];
  
  $node=new stdClass;
  $node->type=$type;


  $new_form_state['type']=$type;
  $new_form_state[$type]['#node']=$node;
  $new_form_state[$type]['type']=$type;
  $new_form_state['target']=$form_state["parents"];
  $new_form_state['parents']=$form_state["parents"];
  
  $new_form_state['cache name']=$form_state["cache name"];
  
  
  $new_form = ctools_build_form('wallyedit_form_editmode_add_form', $new_form_state);
  $commands[] = ctools_ajax_command_html('#wallyedit_container', $new_form);
  
  $commands[] = ctools_ajax_command_html('#wallyedit_messages', theme_status_messages());
    
    
  ctools_ajax_render($commands); 
  
}

function wydit_prepare_inline_form_element(&$form_element,$form_state,$element,$fields,$parents){
  //$node=node_load($form_element[0]['#default_value']['nid']);
  $type_name=$form_state['type'];
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  
  
  $node=$form_state["#node"];
  
  $type_name=$form_state["type"];
  
  $form_state[$node->type]['#node']=$node->node;
  $form_state['type']=$node->type;
  $form_state['#node']=$form_state[$type_name]['#node'];
  //@todo: remove the node key prefere #node
  $form_state[$type_name]['node']=$node;
  
  //$a=array("#false"=>true);      
  $a=drupal_retrieve_form($type_name.'_node_form',$form_state,$form_state[$type_name]['node']);
  drupal_prepare_form($type_name.'_node_form',$a,$form_state);

  $form=array("#type"=>'fieldset');
  unset($a["#type"]);
  unset($a["form_id"]);
  unset($a["#validate"]);
  unset($a["#parents"]);
  
  
          
  
 // unset($a["#parents"]);
  $form[$type_name]=array("#type"=>'fieldset');
  foreach(element_children($a) as $element_name){
    $form[$type_name][$element_name]=$a[$element_name];

    //WARNNING: FIELDS DOESN4T EXIST CAUSE THERE ARE FIELDS FROM THE MAIN CONTENT, SHOUL BRING DIELD INFO FROM NODEREFERENCE CONTENT TYPE
    if(isset($fields[$element_name]) and $fields[$element_name]['display_settings']["wallyedit"]==1 ){
      $form[$type_name][$element_name]["#parents"]=$parents;
    }
  }
  
  wydit_prepare_primary_package_form($form,$form_state,$element,$fields,$parents);
  
  wydit_remove_form_infos($form);
  //$form[$type_name]['select_existing']=array("#type"=>"submit","#value"=>"Select an existing node");
  /*
  
  $form[$type_name]=drupal_retrieve_form($type_name.'_node_form',$form_state,$form_state[$type_name]['node']);
  
  
  drupal_prepare_form($type_name.'_node_form',$form[$type_name],$form_state[$type_name]);
  wydit_prepare_primary_package_form($form[$type_name],$form_state[$type_name],$type,$fields);
  
  
  $form[$type_name]["#tree"]=true;
  wydit_remove_form_infos($form[$type_name]);
  */
  $form_element=$form;
}
function wydit_prepare_selectbox_form_element(&$form_element,$form_state,$element,$fields,$parents){
 
  $form=array(
      "#theme"=>'wydit_selector_theme',
  );
  
  foreach($form_state as $key=>$embed){
    $embed_node=$embed["#node"];

    $form[ $key]['title']=array(
      "#type"=>"markup",
      "#value"=> $embed_node->title,
    );
    $form[$key]['weight_'.$key]=array(
      '#type'=>'weight',
      "#default_value"=> $key,
      '#attributes' => array('class'=>'order_weightss'),
      "#parents"=>array_merge($parents,array("weight_".$key))
    
    );
    $form[$key]['edit_action']=array(
      "#type"=>"submit",
      "#value"=>'edit',
      "#name"=>'edit__'.$parents[count($parents)-1].'_'.$key,
      '#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
      "#parents"=>array_merge($parents,array("$key"))
    );
    $form[$key]['delete_action']=array(
      "#type"=>"submit",
      "#value"=>'remove',
      "#name"=>'remove__'.$parents[count($parents)-1].'_'.$key,
      '#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
      "#parents"=>array_merge($parents,array("$key"))
    );
    
  }
  $form['add_existing_action']=array(
    "#type"=>"submit",
    "#value"=>'add existing one',
    "#name"=>'add_existing__'.$parents[count($parents)-1],
    "#attributes"=>array('class' => 'form-submit ctools-use-ajax'),
    "#parents"=>array_merge($parents,array("add_existing"))
  );
  $form['add_new_action']=array(
    "#type"=>"submit",
    "#value"=>'add new one',
    "#name"=>'add_new__'.$parents[count($parents)-1],
    '#attributes'=>array('class' => 'form-submit ctools-use-ajax'),
    "#parents"=>array_merge($parents,array("add_new"))
  );
  $form_element=$form;
}


//___________________________________________________
function wydit_remove_form_infos(& $form){
  $form["#type"]='fieldset';
  /*
  unset($form["#id"]);
  unset($form["form_id"]);
  unset($form["#token"]);
  unset($form["#parameters"]);
  unset($form["#method"]);
  unset($form["#cache"]);
  unset($form["#action"]);
  unset($form["#form_token"]);
  unset($form["#attributes"]);
  unset($form["#type"]);
  */
}

function wydit_get_infos_type($type_name){
  module_load_include("inc",'content','includes/content.node_form');
  $type=content_types($type_name);
  return $type;
   
}

function wydit_get_inline_type($referencable_types){
  foreach($referencable_types as $key=>$value){
    if($value){
      return $value;
    }
  }
  return NULL;
}

//______________________________

function prenode_load($nid,$reload_node=FALSE){
  $prenode=new Prenode($nid,$reload_node);
  return $prenode;
}
//_______________________________

function wydit_changetypefromfieldset(& $fieldset,$fields){
  if(count($fieldset)==7){
  unset($fieldset['#type']);
  }
 // foreach(element_children($fieldset))


}

/*
NODE PUBLICATION
 */
function wydit_publish_prenode(&$form_state,$sub_level=false){
  //dsm($form_state);
  $form_state[$form_state['type']]=$form_state[$form_state['type']];
  $form_state['type']=$form_state['type'];
  
  $type_name=$form_state['type'];
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  
  foreach($fields as $field){
    if($field['display_settings']["wallyedit"]>1){
      if(isset($form_state[$form_state['type']][$field['field_name']])){
      foreach($form_state[$form_state['type']][$field['field_name']] as $key=>$value){
        $nid=wydit_publish_prenode($form_state[$form_state['type']][$field['field_name']][$key],TRUE);
        unset($form_state[$form_state['type']][$field['field_name']][$key]);
        $form_state[$form_state['type']][$field['field_name']][$key]['nid']=$nid;
        }
      }
      $form_state[$form_state['type']]['#node']->{$field['field_name']}= $form_state[$form_state['type']][$field['field_name']];
    }

  }
 return wydit_publish_prenode_save($form_state,$sub_level);
 // return $form_state;

  
}

function wydit_publish_prenode_save(& $form_state,$sub_level){
  if($sub_level){
    $b=$form_state['#node'];
   }
  else{
    $b=$form_state[$form_state['type']]['#node'];
  }
  $node=node_save($b);
  
  return $b->nid;

}

/*
FORM_STATE MANAGEMENT
*/

//Thx to JDE
function wydit_remove_element($a, $b, $level=0){
  foreach($a as $key => $value){
    if($key == $b[$level]){ //on atteint l'elem de $a correspondant au $path dans $b pour ce niveau de traitement
	  if($level != (count($b)-1)){ //On est pas encore au dernier niveau de traitement
		if(is_array($value)){//logique car il y a encore des niveaux à traiter dans $b;
		  $a[$key] = wydit_remove_element($value, $b, $level+1);
		}
	  }
	  else{
	    unset($a[$b[$level]]); 
	  }	
	}
  }
  return $a;
}



function wydit_add_to_form_state(&$form_state,$element,$target,$append=FALSE){
  if(count($target)>0){
    if(isset($form_state[$target[0]])){
      $key=$target[0];
      array_shift($target);
      wydit_add_to_form_state($form_state[$key],$element,$target,$append);
    }
    else{
      $form_state[$target[0]]=array();
      array_shift($target);
      wydit_add_to_form_state($form_state[$key],$element,$target,$append);
    }
    
  }
  else{
    if($append===TRUE){
      $form_state[]=$element;
    }
    else{
      
      $form_state=$element;
    }
  }
}
  
function wydit_save_form_state($clean_form_state){
  
  ctools_object_cache_set('prenode', $clean_form_state['cache name'], $clean_form_state);
  
}

// here we sync the internal values of the main #node object 
function wydit_clean_form_state($form_state){

  $a[$form_state['type']]=$form_state[$form_state['type']];
  $a['type']=$form_state['type'];
  $a['cache name']=$form_state['cache name'];
  
  $type_name=$form_state['type'];
  
  $type=wydit_get_infos_type($type_name);
  $fields = $type['fields'];
  
  foreach($fields as $field){
         
    if($field['display_settings']["wallyedit"]>1){
      if(isset($form_state[$form_state['type']][$field['field_name']])){
      
      foreach($form_state[$form_state['type']][$field['field_name']] as $key=>$value)
        $a[$form_state['type']][$field['field_name']][$key]['#node']=(object)((array)node_submit($form_state['values'][$form_state['type']][$field['field_name']][$key])+(array)$form_state[$form_state['type']][$field['field_name']][$key]['#node']);
        $a[$form_state['type']][$field['field_name']][$key]['type']=$a[$form_state['type']][$field['field_name']][$key]['#node']->type;
      }
    }
  }
  return $a;
}

function wydit_clean_and_save_form_state(&$form_state){
  $form_state=wydit_clean_form_state($form_state);
  wydit_save_form_state($form_state);
}
function wydit_get_infos_groups($type_name){
    module_load_include("inc",'content','includes/content.node_form');
  
$groups = array();
  if (module_exists('fieldgroup')) {
    $groups = fieldgroup_groups($type_name);
  }
 return $groups; 
}


function wydit_get_current_node_from_parents(&$form_state,$parents=NULL){
  
  if($parents==NULL)
    $parents=$form_state['parents'];
  
  $temp=$form_state;
  foreach($parents as $index=>$cursor_name){
    if(isset($temp[$cursor_name])){
      $temp=& $temp[$cursor_name];
    }
  }
  if($temp["#node"]){
    return $temp["#node"];
  }
  else return NULL;
  
}

function wydit_get_url_action($action,$nid){
  switch ($action){
    case 'edit':
      return 'node/'.$nid.'/edit2/1';
    break;
  }
}


/**
 * Return the unique cart_id of the user.
 */
function wydit_get_cache_name($nid=NULL) {
  global $user;

  if ($nid) {
    return $nid;
  }
  else{
   return  md5(uniqid(rand(), TRUE));
  }
  
}
  
  
  
  
  
  
  
  
  
 
/*
function wallyedit_selector_action_form($context) {
  $roles = selector(TRUE);
  unset($roles[DRUPAL_AUTHENTICATED_RID]);  // Can't edit authenticated role.
  if (module_exists('role_delegation')) {
    foreach ($roles as $rid => $role) {
      if (!user_access('assign all roles') && !user_access(_role_delegation_make_perm($role))) {
        unset($roles[$rid]);
      }
    }
  }

  $form['add_roles'] = array(
    '#type' => 'select',
    '#multiple' => TRUE,
    '#title' => t('Add roles'),
    '#description' => t('Choose one or more roles you would like to assign to the selected users.'),
    '#options' => $roles,
    '#size' => 5
  );
  $form['remove_roles'] = array(
    '#type' => 'select',
    '#multiple' => TRUE,
    '#title' => t('Remove roles'),
    '#description' => t('Choose one or more roles you would like to remove from the selected users.'),
    '#options' => $roles,
    '#size' => 5
  );
  return $form;
}

function wallyedit_selector_action_validate($form, $form_state) {
  if (!$form_state['values']['add_roles'] && !$form_state['values']['remove_roles']) {
    form_set_error('add_roles', t('You have not chosen any role to add or remove. Please select something to do.'));
  }
}

function wallyedit_selector_action_submit($form, $form_state) {
  return array(
    'add_roles' => array_filter($form_state['values']['add_roles']),
    'remove_roles' => array_filter($form_state['values']['remove_roles']),
  );
}
*/

 
function wallyedit_action_info() {
  return array('wallyedit_selector_action' => array(
    'type' => 'node',
    'description' => t('Add thoses nodes to the prenode'),
    'configurable' => FALSE,
    'hooks'=> array('any'=>TRUE),
  ));
}
 function wallyedit_node_operations(){
   $operations = array(
    'wallyedit_selector_action_batch' => array(
      'label' => t('Add thoses nodes to the prenode'),
      'callback' => 'wallyedit_node_operations_selector_action',
    ),
  );
  return $operations;	
 }

  function wallyedit_node_operations_selector_action($nodes,$context,$b,$c){
    $cache_name=$context['arguments'][0];
    $target=explode('/',$context['arguments'][1]);
    array_pop($target);
    
    $prenode=new Prenode($cache_name);
    $form_state=$prenode->getFormState();
    
    foreach($nodes as $nid){
      $node=node_load($nid);    
     $element['#node']=$node;
     $element['type']=$node->type;
     wydit_add_to_form_state($form_state,$element,$target,TRUE);
    
    }
    wydit_clean_and_save_form_state($form_state);
   
  }
function wallyedit_selector_action($node, $context,$a,$b,$c) {
  
  /*
  $roles = $user->roles;
  $selected = (is_array($context['add_roles']) ? $context['add_roles'] : array()) +
              (is_array($context['remove_roles']) ? $context['remove_roles'] : array());
  $result = db_query("SELECT rid, name FROM {role} WHERE rid IN (%s)", implode(',', array_keys($selected)));
  while ($role = db_fetch_object($result)) {
    if (isset($context['add_roles'][$role->rid])) {
      $add_roles[$role->rid] = $role->name;
    }
    if (isset($context['remove_roles'][$role->rid])) {
      $remove_roles[$role->rid] = $role->name;
    }
  }
  if (!empty($add_roles)) {
    $roles += $add_roles;
  }
  if (!empty($remove_roles)) {
    $roles = array_diff($roles, $remove_roles);
  }
  user_save($user, array('roles' => $roles));
  */
}